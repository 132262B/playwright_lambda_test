service: serverless-js-app

frameworkVersion: '4'

provider:
  name: aws
  region: ap-northeast-2
  stage: dev
  architecture: arm64
  ecr:
    images:
      playwright-image:
        path: ./
        file: Dockerfile.chrominum
        platform: linux/arm64
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
            - s3:DeleteObject
            - s3:ListBucket
          Resource:
            - arn:aws:s3:::${self:service}-${self:provider.stage}-screenshots/*
            - arn:aws:s3:::${self:service}-${self:provider.stage}-screenshots
        - Effect: Allow
          Action:
            - sqs:SendMessage
            - sqs:ReceiveMessage
            - sqs:DeleteMessage
            - sqs:GetQueueAttributes
          Resource:
            - !GetAtt TestQueue.Arn

functions:
  runTest:
    image: playwright-image
    events:
      - httpApi:
          path: /
          method: get
    timeout: 30
    memorySize: 3008
    environment:
      HOME: /tmp
      XDG_CONFIG_HOME: /tmp
      XDG_CACHE_HOME: /tmp
      XDG_DATA_HOME: /tmp
      XDG_STATE_HOME: /tmp
      PLAYWRIGHT_BROWSERS_PATH: /tmp
      S3_BUCKET_NAME: ${self:service}-${self:provider.stage}-screenshots
      SQS_QUEUE_URL: !Ref TestQueue

plugins:
  - serverless-offline

custom:
  serverless-offline:
    httpPort: 3000

resources:
  Resources:
    ScreenshotsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:service}-${self:provider.stage}-screenshots
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true
        LifecycleConfiguration:
          Rules:
            - Id: DeleteOldScreenshots
              Status: Enabled
              ExpirationInDays: 30
    
    TestQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${self:provider.stage}-test-queue
        VisibilityTimeout: 300
        MessageRetentionPeriod: 1209600
        ReceiveMessageWaitTimeSeconds: 20
        RedrivePolicy:
          deadLetterTargetArn: !GetAtt TestDLQ.Arn
          maxReceiveCount: 3
    
    TestDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${self:provider.stage}-test-dlq
        MessageRetentionPeriod: 1209600